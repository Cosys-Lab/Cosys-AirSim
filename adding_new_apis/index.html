<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Adding new APIs - Cosys-AirSim</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Adding new APIs";
        var mkdocs_page_input_path = "adding_new_apis.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Cosys-AirSim
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Home</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="" href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/CHANGELOG.md">Changelog</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Installing AirSim</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../run_packaged/">Download and run</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../install_precompiled/">Download and install from precompiled plugin</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../install_windows/">Install from Source on Windows</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../install_linux/">Install from Source on Linux</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../docker_ubuntu/">Using Docker on Ubuntu</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unreal_custenv/">Custom Unreal Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../dynamic_objects/">Dynamic Objects</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Using AirSim</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../apis/">Core APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../image_apis/">Image APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../apis_cpp/">C++ APIs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../instance_segmentation/">Instance Segmentation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../annotation/">Annotation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../camera_views/">Camera Views</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../using_car/">Car Mode</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../remote_control/">Remote Control</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../xbox_controller/">XBox Controller</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../steering_wheel_installation/">Steering Wheel</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../multi_vehicle/">Multiple Vehicles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../skid_steer_vehicle/">Skid Steer Vehicles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../gazebo_drone/">Import Gazebo models</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../retexturing/">Domain Randomization</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../meshes/">Mesh Vertex Buffers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lights/">Artificial Lights</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Sensors</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../sensors/">Sensors</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../lidar/">LIDAR</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../gpulidar/">GPU LIDAR</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../echo/">Pulse Echo</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../InfraredCamera/">Infrared Camera</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../distance_sensor/">Distance Sensor</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">ROS</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../ros_python/">ROS: AirSim ROS Python Wrapper</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../ros_cplusplus/">ROS2: AirSim ROS C++ Wrapper</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../matlab/">Matlab</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../playback/">Playing Logs</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../voxel_grid/">Voxel Grid Generator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../event_sim/">Event camera</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Design</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../modify_recording_data/">Modifying Recording Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../flight_controller/">Flight Controller</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Adding new APIs</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#implementing-the-api">Implementing the API</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#vehicle-based-apis">Vehicle-based APIs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#environment-related-apis">Environment-related APIs</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#physics-related-apis">Physics-related APIs</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#rpc-wrappers">RPC Wrappers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../simple_flight/">Simple Flight</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">External Flight Controllers</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">MavLink and PX4</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../px4_setup/">PX4 Setup for AirSim</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_sitl/">PX4 in SITL</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_sitl_wsl2/">PX4 SITL with WSL 2</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_lockstep/">PX4 Lockstep</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_multi_vehicle/">PX4 Multi-vehicle in SITL</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://youtu.be/1oY8Qu5maQQ">AirSim with Pixhawk</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://youtu.be/HNWdYrtw3f0">PX4 Setup with AirSim</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://www.youtube.com/watch?v=d_FyjKDWQfc&feature=youtu.be">Debugging Attitude Estimation</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://github.com/Microsoft/AirSim/wiki/Intercepting-MavLink-messages">Intercepting MavLink Messages</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://github.com/Microsoft/AirSim/wiki/Rapid-Descent-on-PX4-drones">Rapid Descent on PX4 Drones</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_build/">Building PX4</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../px4_logging/">PX4/MavLink Logging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../log_viewer/">MavLink LogViewer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mavlinkcom/">MavLinkCom</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mavlinkcom_mocap/">MavLink MoCap</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">ArduPilot</a>
    <ul>
                <li class="toctree-l2"><a class="" href="https://ardupilot.org/dev/docs/building-the-code.html">ArduPilot SITL Setup</a>
                </li>
                <li class="toctree-l2"><a class="" href="https://ardupilot.org/dev/docs/sitl-with-airsim.html">AirSim & ArduPilot</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Contributed Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="" href="https://www.youtube.com/watch?v=y09VbdQWvQY">Using Environments from Marketplace</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/simondlevy/AirSimTensorFlow">Simple Collision Avoidance</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://aka.ms/AutonomousDrivingCookbook">Autonomous Driving on Azure</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/Microsoft/AirSim/wiki/hexacopter">Building Hexacopter</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo">Moving on Path Demo</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://youtu.be/Bp86WiLUC80">Importing a custom multirotor mesh</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../object_detection/">Object Detection</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://youtu.be/ZonkdMcwXH4">AirSim with MAVROS and PX4</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Misc</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../custom_drone/">AirSim on Real Drones</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pfm/">pfm format</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unreal_proj/">Setting up Unreal Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../packaging/">Building and Packaging Cosys-AirSim Plugin and/or Unreal Projects</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../unreal_blocks/">Blocks Environment</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../working_with_plugin_contents/">Working with UE Plugin Contents</a>
                  </li>
                  <li class="toctree-l1"><a class="" href="https://github.com/Microsoft/AirSim/wiki/technion">Formula Student Technion Self-drive</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Cosys-AirSim</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Design &raquo;</li>
      <li>Adding new APIs</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/Cosys-Lab/Cosys-AirSim/edit/main/docs/adding_new_apis.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="adding-new-apis-to-airsim">Adding New APIs to AirSim</h1>
<p>Adding new APIs requires modifying the source code. Much of the changes are mechanical and required for various levels of abstractions that AirSim supports. The main files required to be modified are described below along with some commits and PRs for demonstration. Specific sections of the PRs or commits might be linked in some places, but it'll be helpful to have a look at the entire diff to get a better sense of the workflow. Also, don't hesitate in opening an issue or a draft PR also if unsure about how to go about making changes or to get feedback.</p>
<h2 id="implementing-the-api">Implementing the API</h2>
<p>Before adding the wrapper code to call and handle the API, it needs to be implemented first. The exact files where this will occur varies depending on what it does. Few examples are given below which might help you in getting started.</p>
<h3 id="vehicle-based-apis">Vehicle-based APIs</h3>
<p><code>moveByVelocityBodyFrameAsync</code> API for velocity-based movement in the multirotor's X-Y frame.</p>
<p>The main implementation is done in <a href="https://github.com/microsoft/AirSim/pull/3169/files#diff-29ac01a05077b6e8e1f09221a113f779c952a80dc8823725eb451a9fc5d7de5f">MultirotorBaseApi.cpp</a>, where most of the multirotor APIs are implemented.</p>
<p>In some cases, additional structures might be needed for storing data, <a href="https://github.com/microsoft/AirSim/pull/3242"><code>getRotorStates</code> API</a> is a good example for this, here the <code>RotorStates</code> struct is defined in 2 places for conversion from RPC to internal code. It also requires modifications in AirLib as well as Unreal/Plugins for the implementation.</p>
<h3 id="environment-related-apis">Environment-related APIs</h3>
<p>These APIs need to interact with the simulation environment itself, hence it's likely that it'll be implemented inside the <code>Unreal/Plugins</code> folder.</p>
<ul>
<li>
<p><code>simCreateVoxelGrid</code> API to generate and save a binvox-formatted grid of the environment - <a href="https://github.com/microsoft/AirSim/pull/3209/files#diff-89d4ec9b62486b1322e5ba2dd9936b13962f9ed113ec5e35a0678846889c7e2d">WorldSimApi.cpp</a></p>
</li>
<li>
<p><code>simAddVehicle</code> API to create vehicles at runtime - <a href="https://github.com/microsoft/AirSim/pull/2390/files#diff-fcc0aa1fbc74a924fccd12589295aceeea59074c94256eccba7df3ce85d3a26c">SimMode*, WorldSimApi files</a></p>
</li>
</ul>
<h3 id="physics-related-apis">Physics-related APIs</h3>
<p><code>simSetWind</code> API shows an example of modifying the physics behaviour and adding an API + settings field for the same. See <a href="https://github.com/microsoft/AirSim/pull/2867">the PR</a> for details about the code.</p>
<h2 id="rpc-wrappers">RPC Wrappers</h2>
<p>The APIs use <a href="https://github.com/msgpack-rpc/msgpack-rpc">msgpack-rpc protocol</a> over TCP/IP through <a href="http://rpclib.net/">rpclib</a> developed by <a href="https://github.com/sztomi">TamÃ¡s Szelei</a> which allows you to use variety of programming languages including C++, C#, Python, Java etc. When AirSim starts, it opens port 41451 (this can be changed via <a href="../settings/">settings</a>) and listens for incoming request. The Python or C++ client code connects to this port and sends RPC calls using <a href="https://msgpack.org">msgpack serialization format</a>.</p>
<p>To add the RPC code to call the new API, follow the steps below. Follow the implementation of other APIs defined in the files.</p>
<ol>
<li>
<p>Add an RPC handler in the server which calls your implemented method in <a href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/AirLib/src/api/RpcLibServerBase.cpp">RpcLibServerBase.cpp</a>. Vehicle-specific APIs are in their respective vehicle subfolder.</p>
</li>
<li>
<p>Add the C++ client API method in <a href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/AirLib/src/api/RpcLibClientBase.cpp">RpcClientBase.cpp</a></p>
</li>
<li>
<p>Add the Python client API method in <a href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/PythonClient/airsim/client.py">client.py</a>. If needed, add or modify a structure definition in <a href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/PythonClient/airsim/types.py">types.py</a></p>
</li>
</ol>
<h2 id="testing">Testing</h2>
<p>Testing is required to ensure that the API is working as expected. For this, as expected, you'll have to use the source-built AirSim and Blocks environment. Apart from this, if using the Python APIs, you'll have to use the <code>airsim</code> package from source rather than the PyPI package. Below are 2 ways described to go about using the package from source -</p>
<ol>
<li>
<p>Use <a href="https://github.com/Cosys-Lab/Cosys-AirSim/blob/main/PythonClient/multirotor/setup_path.py">setup_path.py</a>. It will setup the path such that the local airsim module is used instead of the pip installed package. This is the method used in many of the scripts since the user doesn't need to do anything other than run the script.
    Place your example script in one of the folders inside <code>PythonClient</code> like <code>multirotor</code>, <code>car</code>, etc. You can also create one to keep things separate, and copy the <code>setup_path.py</code> file from another folder.
    Add <code>import setup_path</code> before <code>import cosysairsim as airsim</code> in your files. Now the latest main API (or any branch currently checked out) will be used.</p>
</li>
<li>
<p>Use a <a href="https://pip.pypa.io/en/stable/cli/pip_install/#local-project-installs">local project pip install</a>. Regular install would create a copy of the current source and use it, whereas Editable install (<code>pip install -e .</code> from inside the <code>PythonClient</code> folder) would change the package whenever the Python API files are changed. Editable install has the benefit when working on several branches or API is not finalized.</p>
</li>
</ol>
<p>It is recommended to use a virtual environment for dealing with Python packaging so as to not break any existing setup.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../flight_controller/" class="btn btn-neutral float-left" title="Flight Controller"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../simple_flight/" class="btn btn-neutral float-right" title="Simple Flight">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/Cosys-Lab/Cosys-AirSim" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../flight_controller/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../simple_flight/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
